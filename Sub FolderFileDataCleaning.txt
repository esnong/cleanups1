Sub TransformEntityData()

    Dim wsSource As Worksheet
    Dim wsOutput As Worksheet
    Dim entityRow As Long, yearCol As Long, outputRow As Long
    Dim entity As String, mappedEntity As String, groupName As String
    Dim value As Variant, year As Integer
    Dim entityMap As Object
    Dim tblRange As Range
    Dim tbl As ListObject
    
    ' Set source sheet by name
    On Error Resume Next
    Set wsSource = Worksheets("STA Project Milestone")
    On Error GoTo 0
    
    If wsSource Is Nothing Then
        MsgBox "Source worksheet 'STA Project Milestone' not found.", vbExclamation
        Exit Sub
    End If
    
    ' Delete output sheet if it exists
    On Error Resume Next
    Application.DisplayAlerts = False
    Worksheets("Transformed Data").Delete
    Application.DisplayAlerts = True
    On Error GoTo 0
    
    ' Add new output sheet
    Set wsOutput = Worksheets.Add
    wsOutput.Name = "Transformed Data"
    
    ' Set header
    With wsOutput
        .Cells(1, 1).Value = "Entity"
        .Cells(1, 2).Value = "Group"
        .Cells(1, 3).Value = "Value"
        .Cells(1, 4).Value = "Year"
    End With
    
    outputRow = 2
    
    ' Create mapping dictionary
    Set entityMap = CreateObject("Scripting.Dictionary")
    entityMap.Add "- PWCS", Array("PWCS CAS", "PWCS")
    entityMap.Add "- PWCS (SHQ)", Array("PWCS SHQ", "PWCS")
    entityMap.Add "- TOS", Array("TOS", "TOS")
    entityMap.Add "- ESA", Array("ESA", "ESA")
    
    ' Loop through rows in source sheet
    For entityRow = 2 To wsSource.Cells(wsSource.Rows.Count, "A").End(xlUp).Row
        entity = Trim(wsSource.Cells(entityRow, 1).Value)
        
        If entityMap.exists(entity) Then
            mappedEntity = entityMap(entity)(0)
            groupName = entityMap(entity)(1)
            
            ' Loop through years (columns B to F = 2022 to 2026)
            For yearCol = 2 To 6
                value = wsSource.Cells(entityRow, yearCol).Value
                year = 2021 + yearCol ' B = 2 â†’ 2022
                
                ' Write to output sheet
                With wsOutput
                    .Cells(outputRow, 1).Value = mappedEntity
                    .Cells(outputRow, 2).Value = groupName
                    .Cells(outputRow, 3).Value = value
                    .Cells(outputRow, 4).Value = year
                End With
                
                outputRow = outputRow + 1
            Next yearCol
        End If
    Next entityRow

    ' Define the table range (headers + data)
    Set tblRange = wsOutput.Range("A1").CurrentRegion

    ' Convert to Excel Table
    Set tbl = wsOutput.ListObjects.Add(xlSrcRange, tblRange, , xlYes)
    tbl.Name = "TransformedEntityTable"
    tbl.TableStyle = "TableStyleMedium2" ' Optional: change style as needed

    MsgBox "Transformation complete and table created!", vbInformation

End Sub
