Sub SearchAcrossCSVFiles()
    Dim folderPath As String
    Dim fileName As String
    Dim searchValue As Variant
    Dim wsDest As Worksheet
    Dim destRow As Long
    Dim wbCSV As Workbook
    Dim wsCSV As Worksheet
    Dim matchFound As Boolean
    Dim lastRow As Long
    Dim lastCol As Long
    Dim cell As Range
    Dim headerCopied As Boolean

    ' Set destination worksheet
    Set wsDest = ThisWorkbook.Sheets(1)
    
    ' Only clear existing output (starting from row 3)
    wsDest.Range("A3:Z10000").ClearContents
    destRow = 3 ' Start output from row 3 to avoid clearing input (B1)

    ' Get the search value from cell B1
    searchValue = wsDest.Range("B1").Value
    If searchValue = "" Then
        MsgBox "Please enter a value in cell B1.", vbExclamation
        Exit Sub
    End If

    ' Ask user to select folder
    With Application.FileDialog(msoFileDialogFolderPicker)
        .Title = "Select a Folder"
        If .Show <> -1 Then Exit Sub
        folderPath = .SelectedItems(1) & "\"
    End With

    Application.ScreenUpdating = False

    ' Loop through all .csv files in the folder
    fileName = Dir(folderPath & "*.csv")
    Do While fileName <> ""
        matchFound = False
        headerCopied = False

        Set wbCSV = Workbooks.Open(folderPath & fileName)
        Set wsCSV = wbCSV.Sheets(1)

        lastRow = wsCSV.Cells(wsCSV.Rows.Count, 1).End(xlUp).Row
        lastCol = wsCSV.Cells(1, wsCSV.Columns.Count).End(xlToLeft).Column

        ' Scan from row 5 onward
        For Each cell In wsCSV.Range(wsCSV.Cells(5, 1), wsCSV.Cells(lastRow, lastCol))
            If cell.Value = searchValue Then
                If Not headerCopied Then
                    ' Copy header row (row 1)
                    wsCSV.Range(wsCSV.Cells(1, 1), wsCSV.Cells(1, lastCol)).Copy wsDest.Cells(destRow, 1)
                    destRow = destRow + 1
                    headerCopied = True
                End If
                ' Copy matched row
                wsCSV.Range(wsCSV.Cells(cell.Row, 1), wsCSV.Cells(cell.Row, lastCol)).Copy wsDest.Cells(destRow, 1)
                destRow = destRow + 1
                matchFound = True
            End If
        Next cell

        If matchFound Then
            destRow = destRow + 1 ' Blank row between results
        End If

        wbCSV.Close False
        fileName = Dir
    Loop

    Application.ScreenUpdating = True
    MsgBox "CSV search complete!", vbInformation
End Sub
