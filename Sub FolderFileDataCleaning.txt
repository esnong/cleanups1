Sub RunCSVSearch()

    Dim searchTerm As String
    Dim folderPath As String
    Dim ws As Worksheet
    Dim resultRow As Long
    Dim fileName As String
    Dim fullPath As String
    Dim wbCSV As Workbook
    Dim wsCSV As Worksheet
    Dim r As Long, col As Long
    Dim lastRow As Long, lastCol As Long
    Dim cellValue As String
    Dim copyCol As Long

    ' Set search input
    Set ws = ThisWorkbook.Sheets("CSV_Search")
    searchTerm = Trim(ws.Range("B1").Value)

    If searchTerm = "" Then
        MsgBox "Please enter a search term in cell B1.", vbExclamation
        Exit Sub
    End If

    ' Folder picker
    With Application.FileDialog(msoFileDialogFolderPicker)
        .Title = "Select Folder with CSV Files"
        If .Show <> -1 Then Exit Sub
        folderPath = .SelectedItems(1) & "\"
    End With

    Application.ScreenUpdating = False
    Application.DisplayAlerts = False

    ' Clear old results
    ws.Range("A5:Z10000").ClearContents
    ws.Range("A4").Value = "File Name"
    ws.Range("B4").Value = "Matched Row"
    resultRow = 5

    fileName = Dir(folderPath & "*.csv")

    Do While fileName <> ""
        fullPath = folderPath & fileName

        ' Open CSV normally (structure is already row/column aligned)
        Set wbCSV = Workbooks.Open(fullPath)
        Set wsCSV = wbCSV.Sheets(1)

        lastRow = wsCSV.Cells(wsCSV.Rows.Count, 1).End(xlUp).Row

        For r = 1 To lastRow
            lastCol = wsCSV.Cells(r, wsCSV.Columns.Count).End(xlToLeft).Column

            For col = 1 To lastCol
                cellValue = wsCSV.Cells(r, col).Text ' Get what is *shown*, not auto-formatted

                If InStr(1, cellValue, searchTerm, vbTextCompare) > 0 Then
                    ' Match found
                    ws.Cells(resultRow, 1).Value = fileName
                    ws.Cells(resultRow, 2).Value = "Row " & r

                    ' Copy all cell values in row, preserving original format
                    For copyCol = 1 To lastCol
                        ws.Cells(resultRow, copyCol + 2).Value = "'" & wsCSV.Cells(r, copyCol).Text
                    Next copyCol

                    resultRow = resultRow + 1
                    Exit For
                End If
            Next col
        Next r

        wbCSV.Close SaveChanges:=False
        fileName = Dir
    Loop

    Application.DisplayAlerts = True
    Application.ScreenUpdating = True

    If resultRow = 5 Then
        MsgBox "No matches found for """ & searchTerm & """", vbInformation
    Else
        MsgBox "Search complete! " & (resultRow - 5) & " matches found.", vbInformation
    End If

End Sub
