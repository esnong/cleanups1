Sub ExtractCAPEXDataForPowerBI()
    Dim wsSource As Worksheet
    Dim wsDest As Worksheet
    Dim cell As Range
    Dim lastRow As Long
    Dim destRow As Long
    Dim capexYear As String
    Dim emptyRowCount As Integer
    Dim currentRow As Long
    Dim headerRow As Long
    Dim groupValue As String
    Dim assetDescription As String
    Dim amountValue As Variant
    Dim sheetName As String

    sheetName = "For Power BI (AE)"

    ' Set the source sheet (the active sheet)
    Set wsSource = ActiveSheet

    ' Delete the existing destination sheet if it exists
    On Error Resume Next
    Application.DisplayAlerts = False
    Worksheets(sheetName).Delete
    Application.DisplayAlerts = True
    On Error GoTo 0

    ' Create a new destination sheet
    Set wsDest = Worksheets.Add(After:=Worksheets(Worksheets.Count))
    wsDest.Name = sheetName

    ' Write headers to the destination sheet
    With wsDest
        .Cells(1, 1).Value = "Group"
        .Cells(1, 2).Value = "Asset Description"
        .Cells(1, 3).Value = "Amount"
        .Cells(1, 4).Value = "Date"
        .Cells(1, 5).Value = "Year"
    End With

    destRow = 2
    lastRow = wsSource.Cells(wsSource.Rows.Count, "B").End(xlUp).Row

    ' Loop through column B to find all <YEAR> CAPEX headers
    For currentRow = 1 To lastRow
        If Trim(wsSource.Cells(currentRow, "B").Value) Like "*#### CAPEX*" Then
            ' Extract year from "<YEAR> CAPEX"
            capexYear = Trim(Split(wsSource.Cells(currentRow, "B").Value)(0))
            headerRow = currentRow
            currentRow = currentRow + 1
            emptyRowCount = 0

            ' Process rows below the CAPEX header
            Do While currentRow <= lastRow And emptyRowCount < 5
                groupValue = Trim(wsSource.Cells(currentRow, "B").Value)
                If groupValue = "" Then
                    emptyRowCount = emptyRowCount + 1
                Else
                    emptyRowCount = 0 ' reset counter if non-empty

                    assetDescription = wsSource.Cells(currentRow, "C").Value
                    amountValue = wsSource.Cells(currentRow, "S").Value

                    ' Write to destination sheet
                    With wsDest
                        .Cells(destRow, 1).Value = groupValue
                        .Cells(destRow, 2).Value = assetDescription
                        .Cells(destRow, 3).Value = amountValue
                        .Cells(destRow, 4).Value = "" ' Date is left blank
                        .Cells(destRow, 5).Value = capexYear
                    End With

                    destRow = destRow + 1
                End If

                currentRow = currentRow + 1
            Loop

            ' Step back one row because the outer loop will increment it again
            currentRow = currentRow - 1
        End If
    Next currentRow

    MsgBox "Data extraction complete. Output written to '" & sheetName & "'.", vbInformation
End Sub
