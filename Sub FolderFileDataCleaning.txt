Sub TransformEDBData()
    Dim srcSheet As Worksheet, destSheet As Worksheet
    Dim wsName As String
    Dim lastRow As Long, destRow As Long
    Dim rawEntity As String, personType As String
    Dim mappedEntity As String, group As String
    Dim yearCol As Long, yearVal As Long, i As Long
    Dim val As Variant
    Dim map As Object

    ' Define mapping dictionary with updated entity names
    Set map = CreateObject("Scripting.Dictionary")
    map.Add "PWCS", Array("PWCS CAS", "PWCS")
    map.Add "PWCS (SHQ)", Array("PWCS SHQ", "PWCS")
    map.Add "TOS", Array("TOS", "TOS")
    map.Add "ESA", Array("ESA", "ESA")
    map.Add "PWS - STA AMO", Array("STA AMO", "STA")
    map.Add "PWS - STA ASE", Array("STA ASE", "STA")

    ' Sheet setup
    Set srcSheet = ThisWorkbook.Sheets("EDB Claim summary")
    wsName = "Transformed Output"

    ' Remove old output sheet if exists
    Application.DisplayAlerts = False
    On Error Resume Next
    ThisWorkbook.Sheets(wsName).Delete
    On Error GoTo 0
    Application.DisplayAlerts = True

    ' Create new output sheet
    Set destSheet = ThisWorkbook.Sheets.Add
    destSheet.Name = wsName

    ' Add headers
    With destSheet
        .Cells(1, 1).Value = "Entity"
        .Cells(1, 2).Value = "Group"
        .Cells(1, 3).Value = "Local/Foreigner"
        .Cells(1, 4).Value = "Value"
        .Cells(1, 5).Value = "Year"
    End With

    destRow = 2
    lastRow = srcSheet.Cells(srcSheet.Rows.Count, "A").End(xlUp).Row

    ' Main loop
    For i = 2 To lastRow
        rawEntity = Trim(CStr(srcSheet.Cells(i, 1).Value))
        personType = Trim(CStr(srcSheet.Cells(i, 2).Value))

        ' Filter: Only process if person type is Local or Foreigner
        If personType <> "Local" And personType <> "Foreigner" Then GoTo NextRow

        ' Check entity in mapping
        If map.exists(rawEntity) Then
            mappedEntity = map(rawEntity)(0)
            group = map(rawEntity)(1)

            ' Loop through years 2022-2026 (columns E to I = 5 to 9)
            For yearCol = 5 To 9
                yearVal = 2022 + (yearCol - 5)
                val = srcSheet.Cells(i, yearCol).Value

                With destSheet
                    .Cells(destRow, 1).Value = mappedEntity
                    .Cells(destRow, 2).Value = group
                    .Cells(destRow, 3).Value = personType
                    .Cells(destRow, 4).Value = val
                    .Cells(destRow, 5).Value = yearVal
                End With

                destRow = destRow + 1
            Next yearCol
        End If

NextRow:
    Next i

    MsgBox "Transformation complete. Output is in '" & wsName & "'.", vbInformation
End Sub
