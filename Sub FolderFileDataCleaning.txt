Sub CreateManpowerUpdate()

    Dim wsSTA As Worksheet, wsUpdate As Worksheet
    Dim wsName As String
    Dim lastCol As Long, lastRow As Long, destRow As Long
    Dim colIndex As Long
    Dim monthCols As Collection
    Dim header As String
    Dim dictMap As Object
    Dim cell As Range
    Dim i As Variant
    Dim orgName As String, mappedOrg As String, groupName As String, category As String
    Dim role As String, staffName As String
    Dim dateLabel As String
    Dim exists As Boolean

    wsName = "Manpower Update (For PowerBI)"
    
    ' Set source worksheet
    Set wsSTA = ThisWorkbook.Sheets("STA")
    
    ' Check if the destination sheet exists
    On Error Resume Next
    Set wsUpdate = ThisWorkbook.Sheets(wsName)
    On Error GoTo 0
    
    If wsUpdate Is Nothing Then
        Set wsUpdate = ThisWorkbook.Sheets.Add(After:=Sheets(Sheets.Count))
        wsUpdate.Name = wsName
    Else
        wsUpdate.Cells.Clear
    End If

    ' Identify all December columns and the last column
    Set monthCols = New Collection
    lastCol = wsSTA.Cells(3, wsSTA.Columns.Count).End(xlToLeft).Column
    
    For colIndex = 6 To lastCol ' Assuming date columns start at column F
        header = wsSTA.Cells(3, colIndex).Text
        If UCase(Left(header, 3)) = "DEC" Then
            monthCols.Add colIndex
        End If
    Next colIndex

    ' Ensure the last column is included
    exists = False
    For Each i In monthCols
        If i = lastCol Then exists = True
    Next i
    If Not exists Then monthCols.Add lastCol

    ' Set new headers in Manpower Update sheet
    With wsUpdate
        .Range("A1").Value = "Entity"
        .Range("B1").Value = "Group"
        .Range("C1").Value = "Local / Foreigner"
        .Range("D1").Value = "Claim Number"
        .Range("E1").Value = "Updated as of"
        .Range("F1").Value = "Claim Year"
        .Range("G1").Value = "Name of Personnel"
        .Range("H1").Value = "Level of Support"
    End With

    destRow = 2

    ' Create mapping dictionary
    Set dictMap = CreateObject("Scripting.Dictionary")
    dictMap.Add "PWS-STA AMO", "STA AMO"
    dictMap.Add "PWS-STA ASE", "STA ASE"
    dictMap.Add "PWCS-SHQ", "PWCS SHQ"
    dictMap.Add "PWCS/CAS", "PWCS CAS"
    dictMap.Add "TOS", "TOS"
    dictMap.Add "ESA", "ESA"

    ' Loop through relevant columns and collect data
    For Each i In monthCols
        dateLabel = wsSTA.Cells(3, i).Text
        lastRow = wsSTA.Cells(wsSTA.Rows.Count, 2).End(xlUp).Row
        
        For Each cell In wsSTA.Range(wsSTA.Cells(4, i), wsSTA.Cells(lastRow, i))
            If UCase(Trim(cell.Value)) = "Y" Then
                orgName = wsSTA.Cells(cell.Row, 2).Value ' Column B
                If dictMap.exists(orgName) Then
                    mappedOrg = dictMap(orgName)
                Else
                    mappedOrg = orgName
                End If
                
                ' Determine group name
                Select Case mappedOrg
                    Case "STA AMO", "STA ASE": groupName = "STA"
                    Case "PWCS SHQ", "PWCS CAS": groupName = "PWCS"
                    Case "TOS": groupName = "TOS"
                    Case "ESA": groupName = "ESA"
                    Case Else: groupName = ""
                End Select
                
                category = wsSTA.Cells(cell.Row, 4).Value ' Column D
                staffName = wsSTA.Cells(cell.Row, 5).Value ' Column E
                role = wsSTA.Cells(cell.Row, 3).Value ' Column C

                ' Fill data into update sheet
                With wsUpdate
                    .Cells(destRow, 1).Value = orgName                     ' Entity
                    .Cells(destRow, 2).Value = mappedOrg                  ' Group
                    .Cells(destRow, 3).Value = groupName                  ' Local / Foreigner (Group)
                    .Cells(destRow, 4).Value = ""                         ' Claim Number (left blank)
                    .Cells(destRow, 5).Value = dateLabel                  ' Updated as of
                    .Cells(destRow, 6).Value = category                   ' Claim Year
                    .Cells(destRow, 7).Value = staffName                  ' Name of Personnel
                    .Cells(destRow, 8).Value = role                       ' Level of Support
                End With
                destRow = destRow + 1
            End If
        Next cell
    Next i

    MsgBox "Manpower Update (For PowerBI) sheet created successfully!", vbInformation

End Sub
