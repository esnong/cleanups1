Sub GenerateOtherEntitiesCapex()
    Dim wsSource As Worksheet, wsTarget As Worksheet
    Dim lastRow As Long, rowIdx As Long, colIdx As Long
    Dim currentYear As String, currentGroup As String
    Dim headerRow As Range
    Dim monthName As String, monthYear As String
    Dim value As Variant
    Dim targetRow As Long
    Dim monthHeaders As Variant
    Dim monthColStart As Long, monthColEnd As Long
    Dim capexYears As Variant

    ' Set the source worksheet
    Set wsSource = ThisWorkbook.Sheets("AE Capex.")

    ' Delete existing "Other Entities Capex" worksheet if it exists
    Application.DisplayAlerts = False
    On Error Resume Next
    ThisWorkbook.Sheets("Other Entities Capex").Delete
    On Error GoTo 0
    Application.DisplayAlerts = True

    ' Add a new worksheet for output
    Set wsTarget = ThisWorkbook.Sheets.Add
    wsTarget.Name = "Other Entities Capex"

    ' Define the output headers
    wsTarget.Range("A1:F1").Value = Array("Group", "Asset Description", "Amount", "Month", "Year", "Month and Year")
    targetRow = 2

    ' CAPEX year headers to look for
    capexYears = Array("2022 CAPEX", "2023 CAPEX", "2024 CAPEX", "2025 CAPEX")

    ' Identify last row and month column range
    lastRow = wsSource.Cells(wsSource.Rows.Count, "B").End(xlUp).Row
    monthColStart = 7 ' Column G
    monthColEnd = 18  ' Column R

    ' Get the month headers
    monthHeaders = wsSource.Range(wsSource.Cells(1, monthColStart), wsSource.Cells(1, monthColEnd)).Value

    ' Loop through each row
    For rowIdx = 2 To lastRow
        Dim entityType As String
        entityType = Trim(wsSource.Cells(rowIdx, 2).Value)

        ' Check if it's a CAPEX year header
        If Not IsError(Application.Match(entityType, capexYears, 0)) Then
            currentYear = Left(entityType, 4)
        ElseIf entityType <> "" Then
            currentGroup = entityType
            Dim assetDesc As String
            assetDesc = wsSource.Cells(rowIdx, 3).Value

            ' Loop through each month column
            For colIdx = monthColStart To monthColEnd
                value = wsSource.Cells(rowIdx, colIdx).Value
                If IsNumeric(value) And value <> 0 Then
                    monthName = wsSource.Cells(1, colIdx).Value
                    monthYear = monthName & "-" & currentYear

                    ' Write to target sheet
                    With wsTarget
                        .Cells(targetRow, 1).Value = currentGroup
                        .Cells(targetRow, 2).Value = assetDesc
                        .Cells(targetRow, 3).Value = value
                        .Cells(targetRow, 4).Value = monthName
                        .Cells(targetRow, 5).Value = currentYear
                        .Cells(targetRow, 6).Value = monthYear
                    End With
                    targetRow = targetRow + 1
                End If
            Next colIdx
        End If
    Next rowIdx

    ' Format as table
    With wsTarget
        .ListObjects.Add(xlSrcRange, .Range("A1").CurrentRegion, , xlYes).Name = "OtherEntitiesCapexTable"
        .Columns("A:F").AutoFit
    End With

    MsgBox "Capex data transformation complete.", vbInformation
End Sub
