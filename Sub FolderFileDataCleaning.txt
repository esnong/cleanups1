Sub CleanAndFormatCSVFiles_UTF8()
    Dim folderPath As String
    Dim fileName As String
    Dim fullPath As String
    Dim fileContent As String
    Dim lineText As String
    Dim lineParts() As String
    Dim i As Long
    Dim fDialog As FileDialog
    Dim lines As Collection
    Dim line As Variant
    Dim ts As Object ' TextStream
    Dim fso As Object ' FileSystemObject

    ' Pick folder
    Set fDialog = Application.FileDialog(msoFileDialogFolderPicker)
    If fDialog.Show <> -1 Then Exit Sub
    folderPath = fDialog.SelectedItems(1) & "\"

    fileName = Dir(folderPath & "*.csv")

    Application.ScreenUpdating = False

    Set fso = CreateObject("Scripting.FileSystemObject")

    Do While fileName <> ""
        fullPath = folderPath & fileName
        Set lines = New Collection

        ' Read file line by line
        Open fullPath For Input As #1
        Do While Not EOF(1)
            Line Input #1, lineText
            lineParts = Split(lineText, "|")
            For i = 0 To UBound(lineParts)
                lineParts(i) = Replace(lineParts(i), "|", "")
                lineParts(i) = Trim(lineParts(i))
            Next i
            lines.Add Join(lineParts, ",")
        Loop
        Close #1

        ' Overwrite with UTF-8 BOM encoding
        Set ts = fso.CreateTextFile(fullPath, True, True) ' True = Overwrite, True = UTF-8
        For Each line In lines
            ts.WriteLine line
        Next line
        ts.Close

        fileName = Dir
    Loop

    Application.ScreenUpdating = True
    MsgBox "All CSV files cleaned and saved properly!"
End Sub

