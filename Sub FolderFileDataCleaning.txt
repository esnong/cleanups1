Sub RunCSVSearch()

    Dim searchTerm As String
    Dim folderPath As String
    Dim ws As Worksheet
    Dim resultRow As Long
    Dim fileName As String
    Dim fullPath As String
    Dim wbCSV As Workbook
    Dim wsCSV As Worksheet
    Dim r As Long, c As Long
    Dim lastRow As Long, lastCol As Long
    Dim foundMatch As Boolean
    Dim fieldInfo() As Variant
    Dim i As Long

    Set ws = ThisWorkbook.Sheets("CSV_Search")
    searchTerm = Trim(ws.Range("B1").Value)

    If searchTerm = "" Then
        MsgBox "Please enter a search term in cell B1.", vbExclamation
        Exit Sub
    End If

    ' Prompt for folder selection
    With Application.FileDialog(msoFileDialogFolderPicker)
        .Title = "Select Folder with CSV Files"
        If .Show <> -1 Then Exit Sub
        folderPath = .SelectedItems(1) & "\"
    End With

    Application.ScreenUpdating = False
    Application.DisplayAlerts = False

    ' Clear previous results
    ws.Range("A5:Z10000").ClearContents
    ws.Range("A4").Value = "File Name"
    ws.Range("B4").Value = "Matched Row"
    resultRow = 5

    fileName = Dir(folderPath & "*.csv")

    Do While fileName <> ""
        fullPath = folderPath & fileName

        ' Read first line to determine column count
        Dim lineText As String, fileNum As Integer, colCount As Long
        fileNum = FreeFile
        Open fullPath For Input As #fileNum
        Line Input #fileNum, lineText
        Close #fileNum
        colCount = UBound(Split(lineText, ",")) + 1  ' Assuming comma-separated

        ' Create FieldInfo array with all columns as Text
        ReDim fieldInfo(1 To colCount, 1 To 2)
        For i = 1 To colCount
            fieldInfo(i, 1) = i
            fieldInfo(i, 2) = xlTextFormat
        Next i

        ' Open file as text, force all fields as text
        Workbooks.OpenText Filename:=fullPath, _
            DataType:=xlDelimited, _
            Comma:=True, _
            FieldInfo:=fieldInfo

        Set wbCSV = ActiveWorkbook
        Set wsCSV = wbCSV.Sheets(1)

        lastRow = wsCSV.Cells(wsCSV.Rows.Count, 1).End(xlUp).Row

        For r = 1 To lastRow
            lastCol = wsCSV.Cells(r, wsCSV.Columns.Count).End(xlToLeft).Column
            For c = 1 To lastCol
                If InStr(1, wsCSV.Cells(r, c).Text, searchTerm, vbTextCompare) > 0 Then
                    ' Match found - copy row to results
                    ws.Cells(resultRow, 1).Value = fileName
                    ws.Cells(resultRow, 2).Resize(1, lastCol).Value = wsCSV.Cells(r, 1).Resize(1, lastCol).Value
                    resultRow = resultRow + 1
                    Exit For
                End If
            Next c
        Next r

        wbCSV.Close SaveChanges:=False
        fileName = Dir
    Loop

    Application.DisplayAlerts = True
    Application.ScreenUpdating = True

    If resultRow = 5 Then
        MsgBox "No matches found for """ & searchTerm & """", vbInformation
    Else
        MsgBox "Search complete! " & (resultRow - 5) & " matches found.", vbInformation
    End If

End Sub
