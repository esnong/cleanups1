Sub RunCSVSearch()

    Dim folderPath As String
    Dim fileName As String
    Dim fullPath As String
    Dim searchTerm As String
    Dim lineText As String
    Dim splitLine() As String
    Dim resultRow As Long
    Dim i As Long
    Dim fileNum As Integer
    Dim ws As Worksheet

    ' Reference the UI sheet
    Set ws = ThisWorkbook.Sheets("CSV_Search")
    searchTerm = Trim(ws.Range("B1").Value)

    If searchTerm = "" Then
        MsgBox "Please enter a search term in cell B1.", vbExclamation
        Exit Sub
    End If

    ' Ask for folder
    With Application.FileDialog(msoFileDialogFolderPicker)
        .Title = "Select Folder with CSV Files"
        If .Show <> -1 Then Exit Sub
        folderPath = .SelectedItems(1) & "\"
    End With

    ' Prepare result area
    ws.Range("A4:Z10000").ClearContents
    ws.Range("A4").Value = "File Name"
    ws.Range("B4").Value = "Matched Row"
    resultRow = 5

    ' Loop through each .csv file
    fileName = Dir(folderPath & "*.csv")

    Do While fileName <> ""
        fullPath = folderPath & fileName
        fileNum = FreeFile

        Open fullPath For Input As #fileNum

        Do While Not EOF(fileNum)
            Line Input #fileNum, lineText

            If InStr(1, lineText, searchTerm, vbTextCompare) > 0 Then
                splitLine = Split(lineText, "|")
                ws.Cells(resultRow, 1).Value = fileName  ' Filename
                For i = 0 To UBound(splitLine)
                    ws.Cells(resultRow, i + 2).Value = splitLine(i) ' Original content
                Next i
                resultRow = resultRow + 1
            End If
        Loop

        Close #fileNum
        fileName = Dir
    Loop

    If resultRow = 5 Then
        MsgBox "No matches found for """ & searchTerm & """", vbInformation
    Else
        MsgBox "Search complete! " & (resultRow - 5) & " matches found.", vbInformation
    End If

End Sub
