Sub RunCSVSearch()

    Dim searchTerm As String
    Dim folderPath As String
    Dim ws As Worksheet
    Dim resultRow As Long
    Dim fileName As String
    Dim fullPath As String
    Dim fileNum As Integer
    Dim lineText As String
    Dim splitLine() As String
    Dim i As Long
    Dim lineCount As Long

    Set ws = ThisWorkbook.Sheets("CSV_Search")
    searchTerm = Trim(ws.Range("B1").Value)

    If searchTerm = "" Then
        MsgBox "Please enter a search term in cell B1.", vbExclamation
        Exit Sub
    End If

    ' Prompt for folder selection
    With Application.FileDialog(msoFileDialogFolderPicker)
        .Title = "Select Folder with CSV Files"
        If .Show <> -1 Then Exit Sub
        folderPath = .SelectedItems(1) & "\"
    End With

    Application.ScreenUpdating = False
    Application.DisplayAlerts = False

    ' Clear previous results
    ws.Range("A5:Z10000").ClearContents
    ws.Range("A4").Value = "File Name"
    ws.Range("B4").Value = "Matched Row"
    resultRow = 5

    fileName = Dir(folderPath & "*.csv")

    Do While fileName <> ""
        fullPath = folderPath & fileName
        fileNum = FreeFile
        lineCount = 0

        Open fullPath For Input As #fileNum
        Do While Not EOF(fileNum)
            Line Input #fileNum, lineText
            lineCount = lineCount + 1

            If InStr(1, lineText, searchTerm, vbTextCompare) > 0 Then
                ' Match found
                splitLine = Split(lineText, "|") ' Adjust delimiter here if needed

                ws.Cells(resultRow, 1).Value = fileName
                ws.Cells(resultRow, 2).Value = "Row " & lineCount

                ' Write values as raw text
                For i = 0 To UBound(splitLine)
                    ws.Cells(resultRow, i + 3).Value = "'" & splitLine(i)
                Next i

                resultRow = resultRow + 1
            End If
        Loop
        Close #fileNum

        fileName = Dir
    Loop

    Application.DisplayAlerts = True
    Application.ScreenUpdating = True

    If resultRow = 5 Then
        MsgBox "No matches found for """ & searchTerm & """", vbInformation
    Else
        MsgBox "Search complete! " & (resultRow - 5) & " matches found.", vbInformation
    End If

End Sub
