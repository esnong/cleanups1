Sub PrepareDataForPowerBI()
    Dim wsSource As Worksheet
    Dim wsTarget As Worksheet
    Dim lastRow As Long
    Dim i As Long, col As Long
    Dim targetRow As Long
    Dim yearStart As Integer
    Dim assetType As String
    Dim tblRange As Range
    Dim tbl As ListObject

    ' Set source worksheet ("STA Capex")
    On Error Resume Next
    Set wsSource = Worksheets("STA Capex")
    On Error GoTo 0
    If wsSource Is Nothing Then
        MsgBox "Worksheet 'STA Capex' not found.", vbCritical
        Exit Sub
    End If

    ' Delete "For PowerBI" sheet if it exists
    Application.DisplayAlerts = False
    On Error Resume Next
    Worksheets("For PowerBI").Delete
    On Error GoTo 0
    Application.DisplayAlerts = True

    ' Create new "For PowerBI" sheet
    Set wsTarget = Worksheets.Add
    wsTarget.Name = "For PowerBI"

    ' Write headers
    wsTarget.Range("A1:D1").Value = Array("Asset Type", "Asset Description", "Amount", "Year")
    targetRow = 2
    yearStart = 2022 ' Column M = 2022

    ' Determine last row in source data
    lastRow = wsSource.Cells(wsSource.Rows.Count, "F").End(xlUp).Row

    ' Loop through rows in source data
    For i = 2 To lastRow
        assetType = Trim(wsSource.Cells(i, "F").Value)
        
        ' Only process "GFA: Buildings" or "GFA: MT&E"
        If assetType = "GFA: Buildings" Or assetType = "GFA: MT&E" Then
            ' Loop through columns M (13) to R (18)
            For col = 13 To 18
                If wsSource.Cells(i, col).Value <> "" Then
                    wsTarget.Cells(targetRow, 1).Value = assetType ' Asset Type
                    wsTarget.Cells(targetRow, 2).Value = wsSource.Cells(i, "G").Value ' Asset Description
                    wsTarget.Cells(targetRow, 3).Value = wsSource.Cells(i, col).Value ' Amount
                    wsTarget.Cells(targetRow, 4).Value = yearStart + (col - 13) ' Year
                    targetRow = targetRow + 1
                End If
            Next col
        End If
    Next i

    ' Create Excel Table from the populated data
    Set tblRange = wsTarget.Range("A1").CurrentRegion
    Set tbl = wsTarget.ListObjects.Add(xlSrcRange, tblRange, , xlYes)
    tbl.Name = "PowerBITable"

    MsgBox "Data prepared successfully on 'For PowerBI' sheet as an Excel Table.", vbInformation
End Sub
